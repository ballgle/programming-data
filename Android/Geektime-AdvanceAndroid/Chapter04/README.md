# [Android开发高手课](https://time.geekbang.org/column/intro/142) 实践 03

>所属章节——内存优化（下）：内存优化这件事，应该从哪里着手？

## 实践：尝试使用 HAHA 库快速判断内存中是否存在重复的图片，并且将这些重复图片的 PNG、堆栈等信息输出

具体参考 [AndroidAdvanceWithGeektime/Chapter03](https://github.com/AndroidAdvanceWithGeektime/Chapter04)。

## 学习心得

**内存优化的两个方面：优化与监控**：

- 内存优化有两个部分
  - 一个是架构：怎么避免产生内存泄漏，这里包括设备分级，缓存管理，进程管理与 Bitmap 图片库的策略。
  - 一个是监控：监控的确是最重要的，因为大部分的内存问题，特别是内存泄露、OOM，更多的时候难点不在于解决，而在于如何发现它们。

开始做内存优化之前，需要先评估内存对应用性能的影响，可以通过崩溃中“异常退出” 和 OOM 的比例进行评估。

**内存优化主要从`设备分级、Bitmap 优化和内存泄漏`三个方面入手**：

1 设备分级：

- 内存优化首先需要根据设备环境来综合考虑，并不是内存占用越少越好
- 要做到针对设备性能的好坏使用不同的内存分配和回收策略需要有一个良好的架构设计支撑
  - 设备分级
  - 缓存管理
  - 进程模型
  - 安装包大小

2 Bitmap 优化：Bitmap 内存一般占应用总内存很大一部分，所以做内存优化永远无法避开图片内存这个“永恒主题”。

- 方法一，统一图片库。
- 方法二，统一监控。
  - 大图片监控。
  - 重复图片监控。
  - 图片总内存。

3 内存泄漏：内存泄漏简单来说就是没有回收不再使用的内存，排查和解决内存泄漏也是内存优化无法避开的工作之一。

- 内存泄漏监控：
  - Java 内存泄漏：建立类似 LeakCanary 自动化检测方案，至少做到 Activity 和 Fragment 的泄漏检测。
  - OOM 监控：参考美团 Android 内存泄露自动化链路分析组件 [Probe](http://ppt.geekbang.org/slide/download/876/593bc30c21689.pdf/19)，当然，该组件也存在一定问题
  - Native 内存泄漏监控：参考[《微信 Android 终端内存优化实践》](http://mp.weixin.qq.com/s/KtGfi5th-4YHOZsEmTOsjg)
  - so 监控
- 开发过程中内存泄漏排查可以使用 Androd Profiler 和 MAT 工具配合使用，而日常监控关键是成体系化，做到及时发现问题。

**内存监控**：常规内存泄漏的监控存在一些性能的问题，一般只会对内部人员和极少部分的用户开启。在线上我们需要通过其他更有效的方式去监控内存相关的问题。

- 采集方式：用户在前台的时候，可以每 5 分钟采集一次 PSS、Java 堆、图片总内存。
- 计算指标：内存异常率、触顶率
- GC 监控
